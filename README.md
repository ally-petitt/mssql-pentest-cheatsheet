# Gaining Access
```
sqsh -S <IP> -U <USERNAME> -P <PASSWORD> <DB NAME> # option 1
dbeaver # option 2
mssqlclient.py -db volume -windows-auth <USERNAME>@<IP> # option 3 (get python script from impacket)
```

# Queries

| Information Obtained | Query |
| -------------------- | ----- |
| Version | SELECT @@version |
| Current User | SELECT SUSER_SNAME() <br/> SELECT SYSTEM_USER |
| Current Role | SELECT IS_SRVROLEMEMBER('sysadmin') <br/> SELECT user |
| Current Database | SELECT db_name() |
| List All Databases | SELECT name FROM master..sysdatabases |
| List All Tables | SELECT TABLE_NAME FROM information_schema.tables <br/> SELECT name FROM master..sysobjects WHERE xtype = 'U'; -- use xtype = 'V' for views <br/> SELECT name FROM someotherdb..sysobjects WHERE xtype = 'U'; <br/> SELECT master..syscolumns.name, TYPE_NAME(master..syscolumns.xtype) FROM master..syscolumns, master..sysobjects WHERE master..syscolumns.id=master..sysobjects.id AND master..sysobjects.name=’sometable’; -- list colum names and types for master..sometable
| List All Logins | SELECT * FROM sys.server_principals WHERE type_desc != 'SERVER_ROLE' |
| List All Users for Database | SELECT * FROM sys.database_principals WHERE type_desc != 'DATABASE_ROLE' |
| List All Sysadmins | SELECT name,type_desc,is_disabled FROM sys.server_principals WHERE IS_SRVROLEMEMBER ('sysadmin',name) = 1 |
| List All Roles | SELECT DP1.name AS DatabaseRoleName,<br/> isnull (DP2.name, 'No members') AS DatabaseUserName<br/> FROM sys.database_role_members AS DRM<br/> RIGHT OUTER JOIN sys.database_principals AS DP1<br/> ON DRM.role_principal_id = DP1.principal_id<br/> LEFT OUTER JOIN sys.database_principals AS DP2<br/> ON DRM.member_principal_id = DP2.principal_id<br/> WHERE DP1.type = 'R'<br/> ORDER BY DP1.name; |
| Effective Permissions for Server | SELECT * FROM fn_my_permissions(NULL, 'SERVER'); |
| Effective Permissions for Database  | SELECT * FROM fn_my_permissions(NULL, 'DATABASE');  |
| Active User Tokens | SELECT * FROM sys.user_token |
| Active Login Tokens | SELECT * FROM sys.login_token |
| Impersonatable Accounts | SELECT distinct b.name<br/> FROM sys.server_permissions a<br/> INNER JOIN sys.server_principals b<br/> ON a.grantor_principal_id = b.principal_id<br/> WHERE a.permission_name = 'IMPERSONATE' |
| Find Trustworthy Databases | SELECT name as database_name <br/>, SUSER_NAME(owner_sid) AS database_owner <br/>, is_trustworthy_on AS TRUSTWORTHY <br/>from sys.databases |
> https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-database-role-members-transact-sql
